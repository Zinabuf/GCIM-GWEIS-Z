#' Compute polygenic risk scores (PRS) in a target sample
#'
#' This function computes PRS using PLINK2 based on SNP effect sizes
#' obtained from GWAS (quantitative or binary) and scales the resulting
#' PRS for downstream GCIM-GWEIS-Z analyses. All outputs are saved to
#' a temporary directory.
#'
#' @param plink_path Character. Path to the PLINK (v2.0) executable.
#' @param tar_snp Character. Prefix of PLINK binary files
#'   (.bed/.bim/.fam) for the target dataset.
#' @param score_file Character. File path to SNP effect file generated by
#'   \code{q_gwas()} or \code{b_gwas()}.
#'   The file must contain the columns ID (SNP ID), A1 (effect allele),
#'   and BETA.
#'
#' @return A list containing PRS outputs stored in a temporary directory:
#' \describe{
#'   \item{sscore_file}{Path to PLINK .sscore file}
#'   \item{prs_scaled_file}{Path to scaled PRS file}
#'   \item{prs_scaled}{Data frame with FID, IID, and scaled PRS}
#'   \item{tmp_dir}{Temporary directory used by the function}
#'   \item{log_file}{Path to PLINK log file}
#'   \item{n_samples}{Number of samples with PRS computed}
#'   \item{n_variants}{Number of variants used in PRS}
#' }
#'
#' @details
#' This function performs the following steps:
#' \enumerate{
#'   \item Validates input files (PLINK binaries and score file)
#'   \item Creates a temporary directory for all outputs
#'   \item Runs PLINK score to compute raw PRS values
#'   \item Standardizes PRS to mean zero and standard deviation one
#'   \item Saves scaled PRS for downstream GCIM-GWEIS-Z analysis
#' }
#'
#' The score file must have columns in the following order:
#' ID, A1, and BETA. These are referenced by PLINK as columns 1, 2, and 3.
#'
#' @export
prs_scores <- function(plink_path,
                       tar_snp,
                       score_file) {

  ## ---- Input validation ----
  if (!file.exists(plink_path)) {
    stop("PLINK executable not found at: ", plink_path)
  }

  if (!file.exists(paste0(tar_snp, ".bed")) ||
      !file.exists(paste0(tar_snp, ".bim")) ||
      !file.exists(paste0(tar_snp, ".fam"))) {
    stop("PLINK binary files (.bed/.bim/.fam) not found with prefix: ", tar_snp)
  }

  if (!file.exists(score_file)) {
    stop("Score file not found: ", score_file)
  }

  ## ---- Validate score file format ----
  score_data <- tryCatch(
    {
      read.table(score_file,
                 header = TRUE,
                 stringsAsFactors = FALSE,
                 nrows = 5)
    },
    error = function(e) {
      stop("Failed to read score file: ", score_file, "\n", e$message)
    }
  )

  required_cols <- c("ID", "A1", "BETA")
  missing_cols <- setdiff(required_cols, colnames(score_data))
  if (length(missing_cols) > 0) {
    stop(
      "Score file missing required columns: ",
      paste(missing_cols, collapse = ", "),
      "\nExpected columns: ID, A1, BETA"
    )
  }

  ## ---- Create function-specific temporary directory ----
  tmp_dir <- file.path(
    tempdir(),
    paste0("prs_scores_", format(Sys.time(), "%Y%m%d_%H%M%S"))
  )

  if (!dir.exists(tmp_dir)) {
    dir.create(tmp_dir, recursive = TRUE)
  }

  message("Output directory: ", tmp_dir)

  out_prefix <- file.path(tmp_dir, "prs")

  ## ---- Run PLINK score computation ----
  message("Step 1 of 3: Computing PRS with PLINK")

  cmd <- paste(
    shQuote(plink_path),
    "--bfile", shQuote(tar_snp),
    "--score", shQuote(score_file), "1 2 3",
    "--out", shQuote(out_prefix)
  )

  exit_code <- system(cmd, ignore.stdout = FALSE, ignore.stderr = FALSE)

  if (exit_code != 0) {
    warning(
      "PLINK exited with non-zero status. Check log file: ",
      paste0(out_prefix, ".log")
    )
  }

  ## ---- Locate and validate PRS output ----
  message("Step 2 of 3: Reading PRS output")

  sscore_file <- paste0(out_prefix, ".sscore")
  log_file <- paste0(out_prefix, ".log")

  if (!file.exists(sscore_file)) {
    stop(
      "PRS output file not found: ", sscore_file,
      "\nCheck PLINK log at: ", log_file
    )
  }

  prs_raw <- tryCatch(
    {
      read.table(
        sscore_file,
        header = TRUE,
        stringsAsFactors = FALSE
      )
    },
    error = function(e) {
      stop("Failed to read PRS output from ", sscore_file, "\n", e$message)
    }
  )

  ## ---- Validate PRS output columns ----
  if (!"SCORE1_SUM" %in% colnames(prs_raw)) {
    stop(
      "Column 'SCORE1_SUM' not found in PRS output. Available columns: ",
      paste(colnames(prs_raw), collapse = ", ")
    )
  }

  if (!all(c("FID", "IID") %in% colnames(prs_raw))) {
    stop("Columns 'FID' and 'IID' not found in PRS output")
  }

  ## ---- Extract number of variants used ----
  n_variants <- NA
  if ("ALLELE_CT" %in% colnames(prs_raw)) {
    n_variants <- median(prs_raw$ALLELE_CT, na.rm = TRUE)
  } else if ("NMISS_ALLELE_CT" %in% colnames(prs_raw)) {
    n_variants <- median(prs_raw$NMISS_ALLELE_CT, na.rm = TRUE)
  }

  ## ---- Extract and scale PRS ----
  message("Step 3 of 3: Scaling PRS")

  prs_scaled <- data.frame(
    FID = prs_raw$FID,
    IID = prs_raw$IID,
    PRS_raw = prs_raw$SCORE1_SUM,
    stringsAsFactors = FALSE
  )

  n_missing <- sum(is.na(prs_scaled$PRS_raw))
  if (n_missing > 0) {
    warning("Found ", n_missing, " samples with missing PRS values")
    prs_scaled <- prs_scaled[!is.na(prs_scaled$PRS_raw), ]
  }

  if (nrow(prs_scaled) == 0) {
    stop("No valid PRS values after removing missing data")
  }

  prs_scaled$PRS <- as.numeric(scale(prs_scaled$PRS_raw))

  if (sd(prs_scaled$PRS_raw) == 0) {
    warning("PRS has zero variance. All samples have identical scores.")
    prs_scaled$PRS <- 0
  }

  ## ---- Save scaled PRS ----
  prs_file <- file.path(tmp_dir, "prs_scaled.txt")

  write.table(
    prs_scaled[, c("FID", "IID", "PRS")],
    file = prs_file,
    row.names = FALSE,
    col.names = TRUE,
    sep = "\t",
    quote = FALSE
  )

  ## ---- Summary statistics ----
  message("PRS computation completed successfully")
  message("  Samples with PRS: ", nrow(prs_scaled))
  if (!is.na(n_variants)) {
    message("  Variants used: ", round(n_variants))
  }
  message("  PRS mean: ", round(mean(prs_scaled$PRS), 4))
  message("  PRS SD: ", round(sd(prs_scaled$PRS), 4))
  message(
    "  PRS range: [",
    round(min(prs_scaled$PRS), 4), ", ",
    round(max(prs_scaled$PRS), 4), "]"
  )
  message("  Results saved to: ", tmp_dir)

  ## ---- Return paths and data for pipeline continuity ----
  result <- list(
    sscore_file = sscore_file,
    prs_scaled_file = prs_file,
    prs_scaled = prs_scaled,
    tmp_dir = tmp_dir,
    log_file = log_file,
    n_samples = nrow(prs_scaled),
    n_variants = n_variants
  )

  invisible(result)
}